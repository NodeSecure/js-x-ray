name: Node.js CI

on:
  push:
    branches: master
  pull_request:

permissions:
  contents: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [22.x, 24.x]
      fail-fast: false
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit # TODO: change to 'egress-policy: block' after couple of runs

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ matrix.node-version }}
      - name: Install dependencies
        run: npm install --ignore-scripts
      - name: Build typescript sources
        run: npm run build
      - name: Run lint
        run: npm run lint
      - name: Run tests
        run: npm run test
      - name: Send coverage report to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v4.0.0-beta.3
      - name: Run Snapshot Benchmark
        if: github.event_name == 'pull_request' && matrix.node-version == '24.x'
        run: node --expose-gc --experimental-strip-types ./workspaces/js-x-ray/benchmark/write-snapshot.ts
      - name: Auto-commit Snapshot Changes
        if: github.event_name == 'pull_request' && matrix.node-version == '24.x' && github.event.pull_request.head.repo.fork == false
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9
        with:
          commit_message: "chore: automated snapshot update [skip ci]"
          file_pattern: "./workspaces/js-x-ray/benchmark/report.json"
      - name: Read updated report
        id: read_report
        if: github.event_name == 'pull_request' && matrix.node-version == '24.x' && github.event.pull_request.head.repo.fork == true
        run: |
          REPORT=$(cat ./workspaces/js-x-ray/benchmark/report.json)
          echo "json_content<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Comment JSON on PR
        if: github.event_name == 'pull_request' && matrix.node-version == '24.x' && github.event.pull_request.head.repo.fork == true
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: "### ðŸ“Š Benchmark Snapshot Update Required"
          edit-mode: replace
          body: |
            ### ðŸ“Š Benchmark Snapshot Update Required

            If you made any update to the application code please copy the JSON below and overwrite the content in:
            `./workspaces/js-x-ray/benchmark/report.json` and push the changes to this PR.

            <details>
            <summary>Click to expand and copy JSON</summary>

            ```json
            ${{ steps.read_report.outputs.json_content }}
            ```

            </details>

            > **Tip:** You can click the copy icon in the top-right corner of the code block above!
  automerge:
    if: >
      github.event_name == 'pull_request' && github.event.pull_request.user.login == 'dependabot[bot]'
    needs:
      - test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Merge Dependabot PR
        uses: fastify/github-action-merge-dependabot@1b2ed42db8f9d81a46bac83adedfc03eb5149dff # v3.11.2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
